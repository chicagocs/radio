<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SRG SSR + Spotify Metadata</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #trackInfo { margin-top: 20px; }
    .label { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Now Playing</h1>
  <div id="trackInfo">
    <p><span class="label">T√≠tulo:</span> <span id="title">Cargando...</span></p>
    <p><span class="label">Artista:</span> <span id="artist">Cargando...</span></p>
    <p><span class="label">√Ålbum:</span> <span id="album">Cargando...</span></p>
  </div>

  <script>
    let currentTrackInfo = null;

    async function fetchMetadata() {
      try {
        // 1Ô∏è‚É£ Intentar SRG SSR
        const srgUrl = 'https://weathered-mode-71a3.chcs.workers.dev/metadata?stream=rsc_de';
        const srgResp = await fetch(srgUrl);
        const srgData = await srgResp.json();

        let title = srgData.title;
        let artist = srgData.artist;
        let album = srgData.album || '';

        // 2Ô∏è‚É£ Fallback a Spotify si no hay datos
        if (!title || !artist) {
          const fallbackArtist = 'Desconocido';
          const fallbackTitle = 'Desconocido';
          const spotifyUrl = `https://weathered-mode-71a3.chcs.workers.dev/spotify?artist=${encodeURIComponent(fallbackArtist)}&title=${encodeURIComponent(fallbackTitle)}`;
          const spotifyResp = await fetch(spotifyUrl);
          const spotifyData = await spotifyResp.json();

          title = spotifyData.title || title || 'Desconocido';
          artist = spotifyData.artist || artist || 'Desconocido';
          album = spotifyData.album || album || '';
        }

        const isNewTrack = !currentTrackInfo || currentTrackInfo.title !== title || currentTrackInfo.artist !== artist;

        if (isNewTrack) {
          console.log('üéµ Nueva canci√≥n detectada:', { title, artist, album });
          currentTrackInfo = { title, artist, album };
          updateUI(currentTrackInfo);
        }

      } catch (err) {
        console.error('Error al obtener metadata:', err);
      }
    }

    function updateUI(track) {
      document.getElementById('title').textContent = track.title;
      document.getElementById('artist').textContent = track.artist;
      document.getElementById('album').textContent = track.album || 'N/A';
    }

    // Ejecutar la primera vez y luego cada 10 segundos
    fetchMetadata();
    setInterval(fetchMetadata, 10000);
  </script>
</body>
</html>
