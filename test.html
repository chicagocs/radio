<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SRG SSR + Spotify Metadata</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .track-info { margin-top: 1em; }
    .track-info span { display: block; margin-bottom: 0.3em; }
  </style>
</head>
<body>
  <h1>SRG SSR + Spotify Metadata</h1>

  <div class="track-info" id="trackInfo">
    <span id="title">T√≠tulo: ‚Äî</span>
    <span id="artist">Artista: ‚Äî</span>
    <span id="album">√Ålbum: ‚Äî</span>
    <span id="duration">Duraci√≥n: ‚Äî</span>
    <span id="genres">G√©neros: ‚Äî</span>
  </div>

  <script>
    const currentTrackInfo = { title: null, artist: null, album: null };
    const srgWorkerUrl = 'https://weathered-mode-71a3.chcs.workers.dev/metadata?stream=rsc_de';
    const spotifyWorkerUrl = 'https://weathered-mode-71a3.chcs.workers.dev/spotify'; // Ajusta seg√∫n tu worker de Spotify

    async function fetchSpotifyMetadata(artist, title, album = '') {
      try {
        const url = new URL(spotifyWorkerUrl);
        url.searchParams.set('artist', artist);
        url.searchParams.set('title', title);
        if (album) url.searchParams.set('album', album);

        const response = await fetch(url);
        if (!response.ok) return null;

        return await response.json();
      } catch (error) {
        console.error('Error al obtener metadata de Spotify:', error);
        return null;
      }
    }

    async function updateTrackInfo() {
      try {
        // 1Ô∏è‚É£ Intentar obtener metadata de SRG SSR
        const srgResponse = await fetch(srgWorkerUrl);
        if (!srgResponse.ok) throw new Error(`SRG SSR HTTP error: ${srgResponse.status}`);

        const srgData = await srgResponse.json();
        console.log('SRG SSR metadata:', srgData);

        let title = srgData.title || null;
        let artist = srgData.artist || null;
        let album = srgData.album || '';

        // 2Ô∏è‚É£ Si SRG SSR no tiene info, usar fallback Spotify
        if (!title || !artist) {
          console.log('‚ö†Ô∏è SRG SSR sin metadata, buscando en Spotify...');
          const spotifyData = await fetchSpotifyMetadata('Desconocido', 'Desconocido'); // Puedes intentar con datos parciales
          if (spotifyData) {
            title = spotifyData.title || title;
            artist = spotifyData.artist || artist;
            album = spotifyData.album || album;
          }
        }

        // 3Ô∏è‚É£ Actualizar UI solo si hay cambio de canci√≥n
        const isNewTrack = title && artist &&
          (currentTrackInfo.title !== title || currentTrackInfo.artist !== artist);

        if (isNewTrack) {
          currentTrackInfo.title = title;
          currentTrackInfo.artist = artist;
          currentTrackInfo.album = album;

          document.getElementById('title').textContent = `T√≠tulo: ${title}`;
          document.getElementById('artist').textContent = `Artista: ${artist}`;
          document.getElementById('album').textContent = `√Ålbum: ${album}`;

          console.log('üîÑ Nueva canci√≥n detectada y UI actualizada');

          // 4Ô∏è‚É£ Actualizar datos extra de Spotify si hay fallback
          const spotifyData = await fetchSpotifyMetadata(artist, title, album);
          if (spotifyData) {
            document.getElementById('duration').textContent = `Duraci√≥n: ${spotifyData.duration || '‚Äî'} s`;
            document.getElementById('genres').textContent = `G√©neros: ${spotifyData.genres?.join(', ') || '‚Äî'}`;
          }
        }

      } catch (error) {
        console.error('Error al actualizar metadata de canci√≥n:', error);
      }
    }

    // Ejecutar cada 10 segundos
    setInterval(updateTrackInfo, 10000);
    // Primera actualizaci√≥n inmediata
    updateTrackInfo();
  </script>
</body>
</html>
